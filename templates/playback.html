<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Timeline - {{ camera_info.name }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { background-color: #343a40; color: #f8f9fa; }
        .player-container { width: 100%; background-color: #000; margin-bottom: 0; }
        #videoPlayer { width: 100%; max-height: 70vh; }
        .timeline-wrapper { position: relative; width: 100%; padding-bottom: 30px; margin-top: 20px; }
        .timeline-container { position: relative; width: 100%; height: 30px; background-color: #dee2e6; border-radius: 5px; overflow: visible; }
        .timeline-event { position: absolute; height: 100%; background-color: #007bff; opacity: 0.8; cursor: pointer; }
        .timeline-hours { display: flex; justify-content: space-between; position: relative; width: 100%; height: 20px; font-size: 12px; color: #6c757d; }
        .hour-marker { width: calc(100% / 24); text-align: left; border-left: 1px solid #ced4da; padding-left: 4px; }
        #live-indicator { position: absolute; top: 0; left: 0; width: 2px; height: 100%; background-color: red; z-index: 3; }
        #playhead-container { position: absolute; top: -10px; left: 0; z-index: 5; display: none; transform: translateX(-50%); }
        #playhead-arrow { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid #28a745; }
        #playhead-time { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; white-space: nowrap; }
        #clip-progress-container { height: 10px; background-color: #495057; display: none; }
        #clip-progress-bar { height: 100%; width: 0%; background-color: #17a2b8; transition: width 0.1s linear; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <a class="navbar-brand" href="/">Mon VMS Web</a>
        <!-- MODIFICATION : La div suivante est SUPPRIMÉE pour retirer les liens redondants. -->
        <!--
        <div>
            <a class="nav-item nav-link d-inline-block" href="/">Grille</a>
            <a class="nav-item nav-link d-inline-block" href="{{ url_for('recordings_page', cam_id=cam_id) }}">Enregistrements</a>
        </div>
        -->
    </nav>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Relecture : {{ camera_info.name }}</h1>
            <input type="date" id="date-selector" class="form-control" style="width: 200px;" value="{{ today }}">
        </div>
        <div class="player-container"><video id="videoPlayer" controls></video></div>
        <div class="progress" id="clip-progress-container"><div class="progress-bar" id="clip-progress-bar" role="progressbar" style="width: 0%"></div></div>
        <div class="timeline-wrapper">
            <div class="timeline-container">
                <div id="events-container"></div>
                <div id="live-indicator"></div>
                <div id="playhead-container"><div id="playhead-time">00:00:00</div><div id="playhead-arrow"></div></div>
            </div>
            <div class="timeline-hours"></div>
        </div>
    </div>
    <script>
        const dateSelector = document.getElementById('date-selector'), eventsContainer = document.getElementById('events-container'), hoursContainer = document.getElementsByClassName('timeline-hours')[0], videoPlayer = document.getElementById('videoPlayer'), liveIndicator = document.getElementById('live-indicator'), playheadContainer = document.getElementById('playhead-container'), playheadTime = document.getElementById('playhead-time'), clipProgressContainer = document.getElementById('clip-progress-container'), clipProgressBar = document.getElementById('clip-progress-bar');
        const camId = "{{ cam_id }}", cameraNameSafe = "{{ camera_info.safe_name }}";
        let currentRecordings = [], currentClipIndex = -1; const totalSecondsInDay = 86400;
        function timeToSeconds(t){const[h,m,s]=t.split(':').map(Number);return h*3600+m*60+s}
        function secondsToTime(s){s=Math.floor(s);const h=String(Math.floor(s/3600)).padStart(2,'0'),m=String(Math.floor(s%3600/60)).padStart(2,'0'),c=String(s%60).padStart(2,'0');return`${h}:${m}:${c}`}
        function drawHourMarkers(){hoursContainer.innerHTML='';for(let i=0;i<24;i++){const m=document.createElement('div');m.className='hour-marker';m.textContent=`${i}h`;hoursContainer.appendChild(m)}}
        function playClip(i){if(i<0||i>=currentRecordings.length){currentClipIndex=-1;playheadContainer.style.display='none';clipProgressContainer.style.display='none';return}currentClipIndex=i;const r=currentRecordings[i],d=dateSelector.value,u=`/play/${cameraNameSafe}/${d}/${r.filename}`;videoPlayer.src=u;videoPlayer.play()}
        async function fetchAndDrawTimeline(){const d=dateSelector.value;eventsContainer.innerHTML='';currentRecordings=[];const t=await fetch(`/api/timeline/${camId}/${d}`),e=await t.json();currentRecordings=e;if(e.length===0){eventsContainer.innerHTML='<div class="text-center p-2" style="color:#6c757d;">Aucun enregistrement.</div>';return}e.forEach((r,i)=>{const s=timeToSeconds(r.start_time),l=s/totalSecondsInDay*100,w=r.duration/totalSecondsInDay*100,d=document.createElement('div');d.className='timeline-event';d.style.left=`${l}%`;d.style.width=`${Math.max(w,.1)}%`;d.title=`Heure: ${r.start_time}, Durée: ${r.duration}s`;d.onclick=()=>playClip(i);eventsContainer.appendChild(d)})}
        function updateLiveIndicator(){const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),t.getDate());liveIndicator.style.left=`${(t-e)/1e3/totalSecondsInDay*100}%`}
        function updatePlayhead(){if(currentClipIndex===-1||videoPlayer.paused||!currentRecordings[currentClipIndex])return;const t=currentRecordings[currentClipIndex],e=timeToSeconds(t.start_time),i=e+videoPlayer.currentTime,n=i/totalSecondsInDay*100;playheadContainer.style.left=`${n}%`;playheadTime.textContent=secondsToTime(i);const o=videoPlayer.currentTime/videoPlayer.duration*100;clipProgressBar.style.width=`${o}%`}
        dateSelector.addEventListener('change',fetchAndDrawTimeline);videoPlayer.addEventListener('timeupdate',updatePlayhead);videoPlayer.addEventListener('ended',()=>playClip(currentClipIndex+1));videoPlayer.addEventListener('play',()=>{playheadContainer.style.display='block';clipProgressContainer.style.display='flex'});videoPlayer.addEventListener('pause',()=>{playheadContainer.style.display='none'});videoPlayer.addEventListener('seeking',updatePlayhead);
        document.addEventListener('DOMContentLoaded',()=>{drawHourMarkers();fetchAndDrawTimeline();updateLiveIndicator();setInterval(updateLiveIndicator,1e4)});
    </script>
</body>
</html>